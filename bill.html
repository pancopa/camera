<!DOCTYPE html>
<html lang="ja">
<head prefix="og: https://ogp.me/ns#">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="appleicon.png">
  <title>bill camera - Try On Hats and Glasses with Ease!</title>
  <meta name="description" content="Exclusive experience for nads! Use the monad AR Camera to place hats and glasses on your face in real-time. Find your favorite items and share them with the community!">
  <meta charset="utf-8">
  <meta property="og:url" content="https://pancopa.github.io/camera/">
  <meta property="og:type" content="website">
  <meta property="og:title" content=" nads camera - Try On Hats and Glasses with Ease!">
  <meta property="og:description" content=" Exclusive experience for nads! Use the monad AR Camera to place hats and glasses on your face in real-time. Find your favorite items and share them with the community!">
  <meta property="og:site_name" content=" nads camera - Try On Hats and Glasses with Ease!">
  <meta property="og:image" content="https://pancopa.github.io/camera/ogp.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #000;
    }
    .input_video {
      display: none;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .button-container {
      position: fixed;
      bottom: 10px;
      display: flex;
      justify-content: flex-end;
      padding-right: 1rem;
      width: 100%;
      z-index: 9999;
    }
    .switch-button {
      width: 48px;
      height: 48px;
      font-size: 24px;
      color: white;
      backdrop-filter: blur(20px);
      background-color: rgba(0, 0, 0, 0.84);
      border: none;
      border-radius: 24px;
      cursor: pointer;
      padding-top: 4px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
</head>

<body>
  <video class="input_video"></video>
  <div class="button-container">
    <button class="switch-button" onclick="switchCamera()"><span class="material-symbols-outlined">flip_camera_ios</span></button>
  </div>
  <script>
    const isFlipped = true;
    let keypointsFace = [];

    const videoElement = document.getElementsByClassName('input_video')[0];
    videoElement.style.display = "none";

    function onResults(results) {
      keypointsFace = results.multiFaceLandmarks;
    }

    const faceMesh = new FaceMesh({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }});

    faceMesh.setOptions({
      maxNumFaces: 100,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    faceMesh.onResults(onResults);

    let camera;
    let currentFacingMode = 'user';

    function setup() {
      createCanvas(windowWidth, windowHeight);
      videoElement.width = windowWidth;
      videoElement.height = windowHeight;
      startCamera(currentFacingMode);
    }

    let imagePNG;

    function preload() {
      imagePNG = loadImage("https://pancopa.github.io/camera/assets/bill/bill.png");
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      videoElement.width = windowWidth;
      videoElement.height = windowHeight;
      startCamera(currentFacingMode);
    }

    function startCamera(facingMode) {
      if (camera) {
        camera.stop();
      }
      camera = new Camera(videoElement, {
        onFrame: async () => {
          await faceMesh.send({image: videoElement});
        },
        width: windowWidth,
        height: windowHeight,
        facingMode: facingMode
      });
      camera.start();
      videoImage = createGraphics(windowWidth, windowHeight);
    }

    function switchCamera() {
      currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
      startCamera(currentFacingMode);
    }

    function draw() {
      clear();
      background("rgba(100, 100, 255, 0.2)");

      videoImage.drawingContext.drawImage(
        videoElement,
        0,
        0,
        videoImage.width,
        videoImage.height
      );

      push();
      if (isFlipped) {
        translate(width, 0);
        scale(-1, 1);
      }
      displayWidth = width;
      displayHeight = (width * videoImage.height) / videoImage.width;
      image(videoImage, 0, 0, displayWidth, displayHeight);
      pop();

      if (keypointsFace.length > 0) {
        keypointsFace.forEach(faceLandmarks => {
          const indexNoseTip = {
            center: faceLandmarks[1],
          };

          const leftEye = faceLandmarks[33];
          const rightEye = faceLandmarks[263];
          const faceWidth = dist(leftEye.x * displayWidth, leftEye.y * displayHeight, rightEye.x * displayWidth, rightEye.y * displayHeight);

          drawImageOnNose(indexNoseTip, displayWidth, displayHeight, faceWidth);
        });
      }
    }

    function drawImageOnNose(position, inputWidth, inputHeight, faceWidth) {
      push();
      imageMode(CENTER);
      tint(255, 255);
      const scaleFactor = faceWidth * 3;
      image(
        imagePNG,
        (1 - position.center.x) * inputWidth,
        position.center.y * inputHeight,
        scaleFactor,
        scaleFactor
      );
      pop();
    }
  </script>
</body>
</html>